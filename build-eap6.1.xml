<?xml version="1.0" encoding="UTF-8"?>
<project name="Install S-RAMP and S-RAMP-UI on EAP 6.1" default="install">

  <property file="build.properties" />

  <property name="overlord-commons-installer.version" value="1.0.7" />
  <property name="modeshape.version" value="3.1.3.Final" />

  <property name="eap.download.url" value="" />
  <property name="modeshape.download.url" value="" />
  <property 
  	  name="overlord-commons-installer.download.url" 
  	  value="https://repository.jboss.org/nexus/content/groups/developer/org/overlord/overlord-commons-installer/${overlord-commons-installer.version}/overlord-commons-installer-${overlord-commons-installer.version}.jar" />

  <property name="installdir" value="${basedir}/target" />
  <property name="eap.as.dist.dir" value="${installdir}/jboss-eap-6.1" />

  <target name="install">
    <echo message=" " />
    <echo message="#############################################" />
    <echo message="# Running the S-RAMP installer.  This will  #" />
    <echo message="# install S-RAMP and the S-RAMP UI into     #" />
    <echo message="# EAP 6.1.                                  #" />
    <echo message="#############################################" />
    <mkdir dir="${installdir}"/>

    <echo>-----------------------------</echo>
    <echo>Downloading EAP 6.1</echo>
    <echo>-----------------------------</echo>
    <get src="${eap.download.url}" dest="${installdir}/jboss-eap-6.1.0.zip" usetimestamp="true" />

    <echo>-----------------------------------</echo>
    <echo>Downloading ModeShape</echo>
    <echo>-----------------------------------</echo>
    <get src="${modeshape.download.url}" dest="${installdir}/modeshape-${modeshape.version}.zip" usetimestamp="true" />

    <echo>--------------------------------------</echo>
    <echo>Downloading Overlord Commons Installer</echo>
    <echo>--------------------------------------</echo>
    <get src="${overlord-commons-installer.download.url}" 
    	dest="${installdir}/overlord-commons-installer-${overlord-commons-installer.version}.jar" usetimestamp="true" />

    <echo>-----------------</echo>
    <echo>Unzipping EAP 6.1</echo>
    <echo>-----------------</echo>
    <delete dir="${eap.as.dist.dir}" />
    <unzip src="${installdir}/jboss-eap-6.1.0.zip" dest="${installdir}" overwrite="true" />
    <copy file="updates/layers.conf" todir="${eap.as.dist.dir}/modules"/>

    <echo>------------------------------------</echo>
    <echo>Unzipping Overlord Commons Installer</echo>
    <echo>------------------------------------</echo>
    <unzip src="${installdir}/overlord-commons-installer-${overlord-commons-installer.version}.jar" 
           dest="${installdir}/overlord-commons-installer-${overlord-commons-installer.version}" overwrite="false" />
    <ant antfile="build.xml" 
         dir="${installdir}/overlord-commons-installer-${overlord-commons-installer.version}" 
         target="install-all" />

    <echo>----------------------------</echo>
    <echo>Installing Modeshape Service</echo>
    <echo>----------------------------</echo>
    <unzip src="${installdir}/modeshape-${modeshape.version}.zip"  dest="${installdir}/modeshape" overwrite="false" />
    <move file="${installdir}/modeshape/modules/org"   todir="${eap.as.dist.dir}/modules/system/layers/soa" />
    <move file="${installdir}/modeshape/modules/javax" todir="${eap.as.dist.dir}/modules/system/layers/soa" />
    <move file="${installdir}/modeshape/docs"  todir="${eap.as.dist.dir}/" />
    <delete>
      <dirset dir="${eap.as.dist.dir}/modules/system/layers/soa/org/modeshape/">
        <include name="**/META-INF"/>
      </dirset>
    </delete>

    <echo>-----------------------------</echo>
    <echo>Configuring Modeshape Service</echo>
    <echo>-----------------------------</echo>
    <xslt 
      style="updates/xslt/configureModeshape-eap6.1.xslt"
      in="${eap.as.dist.dir}/standalone/configuration/standalone.xml"
      out="${installdir}/_tmp_standalone-ms.xml" />
    <copy file="${installdir}/_tmp_standalone-ms.xml" tofile="${eap.as.dist.dir}/standalone/configuration/standalone.xml" overwrite="true" />
    <delete file="${installdir}/_tmp_standalone-ms.xml" />
    <copy file="updates/modeshape-module-eap6.1.xml" tofile="${eap.as.dist.dir}/modules/system/layers/soa/org/modeshape/main/module.xml" />

    <echo>------------------------------</echo>
    <echo>Deploying S-RAMP and S-RAMP UI</echo>
    <echo>------------------------------</echo>
    <copy file="${project.build.directory}/s-ramp-server-${s-ramp.version}.war" 
          tofile="${eap.as.dist.dir}/standalone/deployments/s-ramp-server.war" overwrite="true" />
    <copy file="${project.build.directory}/s-ramp-ui-${s-ramp-ui.version}.war" 
          tofile="${eap.as.dist.dir}/standalone/deployments/s-ramp-ui.war" overwrite="true" />

    <echo>-------------------------</echo>
    <echo>Configuring Overlord Apps</echo>
    <echo>-------------------------</echo>
    <property name="overlord-apps.dir" value="${eap.as.dist.dir}/standalone/configuration/overlord-apps" />
  	<mkdir dir="${overlord-apps.dir}" />
    <copy file="updates/sramp.properties" todir="${eap.as.dist.dir}/standalone/configuration/" overwrite="true" />
    <copy file="updates/srampui-overlordapp.properties" todir="${overlord-apps.dir}" overwrite="true" />
  	
  	<!-- Enable remote debugging -->
    <copy file="updates/standalone-eap6.1.conf" tofile="${eap.as.dist.dir}/bin/standalone.conf" overwrite="true" />

    <echo message=" " />
    <echo message="########" />
    <echo message="# DONE #" />
    <echo message="########" />
    <echo message=" " />
  </target>

</project>
